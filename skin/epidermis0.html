<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>T cell in epidermis</title>
<meta charset="utf-8">
<script type="text/javascript" src="../src/DiceSet.js"></script>
<script type="text/javascript" src="../src/CPM.js"></script>
<script type="text/javascript" src="../src/CPMStats.js"></script>
<script type="text/javascript" src="../src/CPMCanvas.js"></script>
<script type="text/javascript" src="../src/BGCanvas.js"></script>
<script type="text/javascript" src="../src/CPMchemotaxis.js"></script>
<script type="text/javascript" src="../src/TrackCanvas.js"></script>
<script type="text/javascript" src="./simulation-tissue.js"></script>
<script type="text/javascript" src="./CPMskin-template.js"></script>
<script type="text/javascript" src="./CPMskin-settings.js"></script>
<script type="text/javascript" src="lib/d3/d3.js"></script>
<script type="text/javascript" src="../conrec.js"></script>
<script type="text/javascript">


var C,Cim,Ct,Cs, showtracks=simsettings["VIEWTRACKS"], stopped=true, zoom=3, wrap=[0,0]

// used to name the sliders
var names = {
	LAMBDA_ACT : "&lambda;<sub>Act</sub>",
	MAX_ACT : "Max<sub>Act</sub>",
	LAMBDA_P : "&lambda;<sub>P,tissue</sub>"
}

var runtime = 1000
var field_size = 200
var kera_cells_factor = (field_size*field_size)/(200*200)
var max_CTL = 100*( (field_size*field_size) / (600*600) )
var chemotaxis = 30
var infectionStart = 0.20
var entryBias = 0

function initialize(){
	Cset = CsetChemotaxis
	Cset.conf["LAMBDA_CHEMOTAXIS"][1] = chemotaxis
	C = new CPMchemotaxis( Cset.ndim, {x:field_size,y:field_size}, Cset.conf)
	C.entryBias = entryBias
	C.maxTCells = max_CTL
	Cim = new CPMCanvas( C, {zoom:zoom,wrap:wrap} )
	Cimgradient = new BGCanvas( C, {zoom:zoom, wrap:wrap} )

	Cs = new CPMStats( C )
	Ct = new TrackCanvas( Cs, {zoom:zoom} )

	Cim.el.onclick=function(){
			sim.stop = true
			document.location.href = Cim.el.toDataURL("image/png").
				replace("image/png", "image/octet-stream");
 		}
	//simsettings["CANVASCOLOR"] = "eaecef"

	simsettings["RUNTIME"] = runtime
	simsettings["NRCELLS"][1] *= kera_cells_factor
	sim = new simulation( C, Cim, Cs, simsettings, Ct )
	sim.initialize()
	seedInfection()
	step()
}

function seedInfection() {
	let centroids = Cs.getCentroids()
	for (let i = 0; i < centroids.length; i++) {
		if(Math.sqrt(Math.pow((centroids[i].x - (field_size/2)), 2) + Math.pow((centroids[i].y - (field_size/2)), 2)) < (field_size*infectionStart)) {
			C.infection[centroids[i].id] = C.maxInfection / 2
			C.setCellKind(centroids[i].id, 3)
		}
	}
}

function contourplot(chemokinelevel) {

	const data = [];
	for (let x = 0; x < field_size; x++){
		const datarow = [];
		for (let y = field_size - 1; y >= 0 ; y--){
			datarow.push(Math.log10(chemokinelevel[x][y]+5)/5)
		}
		data.push(datarow)
		// console.log(data)
	}


	var cliff = -1000;
	data.push(d3.range(data[0].length).map(function() { return cliff; }));
	data.unshift(d3.range(data[0].length).map(function() { return cliff; }));
	data.forEach(function(d) {
	  d.push(cliff);
	  d.unshift(cliff);
	});

	var c = new Conrec,
	    xs = d3.range(0, data.length),
	    ys = d3.range(0, data[0].length),
	    zs = d3.range(0.1, 0.7, 0.05),
	    width = 600,
	    height = 600,
	    x = d3.scale.linear().range([0, width]).domain([0, data.length]),
	    y = d3.scale.linear().range([height, 0]).domain([0, data[0].length]),
	    colours = d3.scale.linear().domain([0.1, 0.7]).range(["#fff", "blue"]);

	c.contour(data, 0, xs.length - 1, 0, ys.length - 1, xs, ys, zs.length, zs);

	d3.select("body").append("svg")
	    .attr("width", width)
	    .attr("height", height)
	  .selectAll("path")
	    .data(c.contourList())
	  .enter().append("path")
	    .style("fill",function(d) { return colours(d.level);})
	    .style("stroke","black")
	    .attr("d", d3.svg.line()
	      .x(function(d) { return x(d.x); })
	      .y(function(d) { return y(d.y); }));

}

// Perform a step in the model
function step(){

	for( var i = 0; i < 1; i++ ){
		sim.timestep()
	}

	sim.drawCanvas()
	C.produceChemokine()
	for (let i = 0; i < 100; i ++){
		C.updateValues()
	}
	C.removeChemokine()
	if(sim.time%20 == 0){
		contourplot(C.chemokinelevel)
		// Cimgradient.drawChemokineGradientFromList( "ffffff" )
		// Cimgradient.drawChemokineGradientFromList( "0061ff" )
		// Cim.ctx.drawImage( Cimgradient.el,0,0)
	}

	// Cim.writePNG("output/" + sim.time + ".png")



	if( sim.time+1 < sim.runtime ){
		//if( sim.atBorder() ){
		//	sim.reset()
		//}
		if( !sim.stop ){
			requestAnimationFrame( step )
		}

	}
}

// For controlling the simulation
function startSim(){
	sim.stop = false
	step()
}

function stopSim(){
	sim.stop = true
}

</script>
</script>


<style type="text/css">
body, html{
	margin: 5 ; padding: 5;

}
body{
	 min-width: 300px; min-height: 300pxs
}
</style>


<body onload="initialize()">



</body>
</html>
